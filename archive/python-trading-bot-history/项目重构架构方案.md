# 项目重构架构方案

## 🏗️ 新架构设计：分离项目生态系统

### 架构理念
> "分而治之，各司其职。独立运行，风险隔离。"

## 📁 完整目录结构

```
reverse-trading-ecosystem/
├── README.md                           # 生态系统总览
├── deploy/                             # 部署脚本
│   ├── docker-compose.yml
│   ├── simple-bot.dockerfile
│   └── turtle-bot.dockerfile
│
├── core-lib/                           # 🧠 共享核心库
│   ├── setup.py                       # 库安装配置
│   ├── core/                          # 基础组件
│   │   ├── __init__.py
│   │   ├── config.py                  # 配置管理
│   │   ├── logger.py                  # 日志系统
│   │   └── exceptions.py              # 异常体系
│   ├── signal_processor/              # 信号处理
│   │   ├── __init__.py
│   │   ├── signal_parser.py
│   │   ├── signal_validator.py
│   │   ├── telegram_listener.py
│   │   └── signal_dispatcher.py
│   ├── trading_engine/                # 交易引擎
│   │   ├── __init__.py
│   │   ├── exchange_client.py
│   │   ├── order_executor.py          # 待实现
│   │   ├── price_monitor.py           # 待实现
│   │   └── balance_manager.py         # 待实现
│   └── utils/                         # 工具模块
│       ├── __init__.py
│       ├── time_utils.py
│       ├── math_utils.py
│       └── validation_utils.py
│
├── simple-reverse-bot/                 # 🤖 项目A：简单反向机器人
│   ├── README.md                      # 项目说明
│   ├── requirements.txt               # 依赖管理
│   ├── config/                        # 配置文件
│   │   ├── config.json                # 主配置
│   │   ├── trading.json               # 交易配置
│   │   └── risk.json                  # 风控配置
│   ├── strategy/                      # 策略实现
│   │   ├── __init__.py
│   │   ├── simple_reverse_strategy.py # 简单反向策略
│   │   └── risk_manager.py            # 风险管理
│   ├── logs/                          # 日志目录
│   ├── data/                          # 数据存储
│   ├── tests/                         # 测试用例
│   │   ├── test_strategy.py
│   │   └── test_integration.py
│   ├── main.py                        # 启动入口
│   └── monitor.py                     # 监控脚本
│
├── turtle-reverse-bot/                 # 🐢 项目B：海龟滚仓机器人
│   ├── README.md                      # 项目说明
│   ├── requirements.txt               # 依赖管理
│   ├── config/                        # 配置文件
│   │   ├── config.json                # 主配置
│   │   ├── turtle_strategy.json       # 海龟策略配置
│   │   └── risk.json                  # 风控配置
│   ├── strategy/                      # 策略实现
│   │   ├── __init__.py
│   │   ├── turtle_reverse_strategy.py # 海龟反向策略
│   │   ├── position_manager.py        # 仓位管理
│   │   └── profit_manager.py          # 分层止盈管理
│   ├── logs/                          # 日志目录
│   ├── data/                          # 数据存储
│   ├── tests/                         # 测试用例
│   │   ├── test_turtle_strategy.py
│   │   └── test_position_manager.py
│   ├── main.py                        # 启动入口
│   └── monitor.py                     # 监控脚本
│
└── monitoring-dashboard/               # 📊 可选：统一监控面板
    ├── README.md
    ├── requirements.txt
    ├── web/                           # Web界面
    │   ├── static/
    │   ├── templates/
    │   └── app.py
    ├── api/                           # API接口
    │   ├── __init__.py
    │   ├── bot_monitor.py
    │   └── performance_api.py
    └── config/
        └── dashboard.json
```

## 🔄 重构步骤

### 第一阶段：核心库抽取
1. **创建 core-lib 包**
   - 移动现有的 core/、signal_processor/、trading_engine/ 到 core-lib
   - 创建 setup.py 使其可安装
   - 添加版本管理

2. **库依赖管理**
   ```python
   # core-lib/setup.py
   setup(
       name="reverse-trading-core",
       version="1.0.0",
       packages=find_packages(),
       install_requires=[
           "ccxt>=4.1.87",
           "telethon>=1.32.1", 
           "nest-asyncio>=1.5.8",
           "pytz>=2023.3"
       ]
   )
   ```

### 第二阶段：简单机器人项目
1. **独立项目结构**
   ```
   simple-reverse-bot/
   ├── main.py                 # 精简的启动程序
   ├── strategy/               # 只包含简单策略
   └── config/                 # 独立配置
   ```

2. **依赖管理**
   ```txt
   # requirements.txt
   reverse-trading-core==1.0.0  # 引用核心库
   ```

3. **独立配置**
   ```json
   {
     "strategy": {
       "name": "SimpleReverse",
       "profit_target": 0.30,
       "max_position_size": 500,
       "enabled_quantities": [1, 2, 3, 4, 5, 6]
     },
     "risk": {
       "max_daily_loss": 0.05,
       "position_timeout_hours": 4,
       "emergency_stop_loss": 0.15
     }
   }
   ```

### 第三阶段：海龟机器人项目
1. **独立项目结构**
   ```
   turtle-reverse-bot/
   ├── main.py                 # 专门的启动程序
   ├── strategy/               # 复杂的海龟策略
   └── config/                 # 海龟专用配置
   ```

2. **海龟策略配置**
   ```json
   {
     "turtle_strategy": {
       "position_sizes": {
         "1": 10, "2": 20, "3": 30, 
         "4": 40, "5": 50, "6": 60
       },
       "profit_thresholds": {
         "3": 0.50, "4": 0.30, "5": 0.30, "6": 0.30
       },
       "close_ratios": {
         "3": 0.50, "4": 0.80, "5": 0.90, "6": 0.90
       }
     }
   }
   ```

## 🔧 关键实现文件

### core-lib/setup.py
```python
from setuptools import setup, find_packages

setup(
    name="reverse-trading-core",
    version="1.0.0",
    description="反向跟单机器人核心库",
    packages=find_packages(),
    install_requires=[
        "ccxt>=4.1.87",
        "telethon>=1.32.1",
        "nest-asyncio>=1.5.8", 
        "pytz>=2023.3"
    ],
    python_requires=">=3.8"
)
```

### simple-reverse-bot/main.py
```python
import asyncio
from reverse_trading_core.core.config import init_config
from reverse_trading_core.signal_processor import TelegramListener
from strategy.simple_reverse_strategy import SimpleReverseStrategy

async def main():
    config = init_config("config/config.json")
    strategy = SimpleReverseStrategy(config)
    listener = TelegramListener()
    
    # 连接信号处理
    listener.add_signal_handler(strategy.process_signal)
    
    # 启动系统
    await strategy.start()
    await listener.start_listening()

if __name__ == "__main__":
    asyncio.run(main())
```

### turtle-reverse-bot/main.py
```python
import asyncio
from reverse_trading_core.core.config import init_config
from reverse_trading_core.signal_processor import TelegramListener
from strategy.turtle_reverse_strategy import TurtleReverseStrategy

async def main():
    config = init_config("config/config.json")
    strategy = TurtleReverseStrategy(config)
    listener = TelegramListener()
    
    # 连接信号处理
    listener.add_signal_handler(strategy.process_signal)
    
    # 启动系统
    await strategy.start()
    await listener.start_listening()

if __name__ == "__main__":
    asyncio.run(main())
```

## 🚀 部署方案

### Docker Compose 部署
```yaml
# deploy/docker-compose.yml
version: '3.8'
services:
  simple-bot:
    build:
      context: ../simple-reverse-bot
      dockerfile: ../deploy/simple-bot.dockerfile
    environment:
      - BOT_TYPE=simple
    volumes:
      - ./logs/simple:/app/logs
      - ./data/simple:/app/data
    restart: unless-stopped
    
  turtle-bot:
    build:
      context: ../turtle-reverse-bot  
      dockerfile: ../deploy/turtle-bot.dockerfile
    environment:
      - BOT_TYPE=turtle
    volumes:
      - ./logs/turtle:/app/logs
      - ./data/turtle:/app/data
    restart: unless-stopped
```

## 🎯 架构优势

### 1. **风险隔离**
- 独立进程，一个崩溃不影响另一个
- 独立资金池，避免策略间资金竞争
- 独立配置，策略参数互不干扰

### 2. **简化部署**
- 每个项目职责单一，部署简单
- 可以选择性部署（只运行其中一个）
- 独立扩展，不同策略可以部署到不同服务器

### 3. **维护性强**
- 代码结构清晰，便于维护
- 独立测试，问题定位准确
- 版本管理独立，升级风险可控

### 4. **可扩展性**
- 新策略可以独立成项目
- 核心库统一维护和升级
- 监控系统可选择性接入

---

**下一步：开始创建重构后的项目结构**